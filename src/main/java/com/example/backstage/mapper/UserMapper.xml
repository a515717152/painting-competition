<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.backstage.dao.UserMapper">

    <select id="getUserList" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT
        t_user.id,
        t_user.nickname,
        t_user.username,
        t_user.`password`,
        t_user.role_id
        FROM
        t_user
        <where>
            1=1
            <if test="username != null and username !=''">and username = #{username}</if>
            <if test="delete_flag != null and delete_flag !=''">and delete_flag = #{delete_flag}</if>
            <if test="stage != null and stage !=''">and stage = #{stage}</if>
        </where>
    </select>

    <select id="getRole" parameterType="java.util.Map" resultType="String">
        SELECT
        t_role.rolename
        FROM
        t_role
        <where>
            1=1
            and t_role.id = (
            SELECT
            t_user.role_id
            from
            t_user
            <where>
                1=1
                <if test="username != null and username !=''">and username = #{username}</if>
                <if test="delete_flag != null and delete_flag !=''">and t_user.delete_flag = #{delete_flag}</if>
                <if test="stage != null and stage !=''">and t_user.stage = #{stage}</if>
            </where>
            )
        </where>
    </select>

    <select id="getPermission" parameterType="java.util.Map" resultType="String">
        SELECT
        t_permission.permissionname
        FROM
        t_permission
        <where>
            1=1
            and t_permission.role_id = (
            SELECT
            t_user.role_id
            from
            t_user
            <where>
                1=1
                <if test="username != null and username !=''">and username = #{username}</if>
                <if test="delete_flag != null and delete_flag !=''">and t_user.delete_flag = #{delete_flag}</if>
                <if test="stage != null and stage !=''">and t_user.stage = #{stage}</if>
            </where>
            )
            <if test="delete_flag != null and delete_flag !=''">and t_permission.delete_flag = #{delete_flag}</if>
            <if test="stage != null and stage !=''">and t_permission.stage = #{stage}</if>
        </where>
    </select>

    <insert id="addUser" parameterType="java.util.Map">
        INSERT INTO t_user
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null and id !=''">id,</if>
            <if test="nickname != null and nickname !=''">nickname,</if>
            <if test="username != null and username !=''">username,</if>
            <if test="password != null and password !=''">password,</if>
            <if test="role_id != role_id">role_id,</if>
            <if test="delete_flag != null and delete_flag !=''">delete_flag,</if>
            <if test="stage != null and stage !=''">stage,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null and id !=''">#{id},</if>
            <if test="nickname != null and nickname !=''">#{nickname},</if>
            <if test="username != null and username !=''">#{username},</if>
            <if test="password != null and password !=''">md5(#{password}),</if>
            <if test="role_id != role_id">#{role_id},</if>
            <if test="delete_flag != null and delete_flag !=''">#{delete_flag},</if>
            <if test="stage != null and stage !=''">#{stage},</if>
        </trim>
    </insert>
</mapper>